From ee016e734d6b286913b7c0464c35b5160c3305de Mon Sep 17 00:00:00 2001
From: Kaustubh Gondkar <kgondkar@codeaurora.org>
Date: Fri, 18 Oct 2013 19:38:06 -0700
Subject: [PATCH 1/2] SOM bringup with basic BSP updates

---
 arch/arm/mach-msm/Kconfig              |  6 +++++
 arch/arm/mach-msm/Makefile             |  1 +
 arch/arm/mach-msm/board-8064-gpiomux.c | 45 +++++++++++++++++++++++++++++++--
 arch/arm/mach-msm/board-8064.c         | 46 +++++++++++++++++++++++++++++-----
 arch/arm/mach-msm/clock-8960.c         |  8 ++++++
 arch/arm/mach-msm/devices-8064.c       | 28 +++++++++++++++++++++
 arch/arm/mach-msm/devices.h            |  1 +
 arch/arm/tools/mach-types              |  1 +
 drivers/media/video/msm/Makefile       |  3 ++-
 9 files changed, 130 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-msm/Kconfig b/arch/arm/mach-msm/Kconfig
index d227e72..f3dd09b 100644
--- a/arch/arm/mach-msm/Kconfig
+++ b/arch/arm/mach-msm/Kconfig
@@ -878,6 +878,12 @@ config MACH_APQ8064_LIQUID
 	help
 	  Support for the Qualcomm APQ8064 LIQUID device.
 
+config MACH_APQ8064_SOM
+	depends on ARCH_APQ8064
+	bool "APQ8064 SOM"
+	help
+	  Support for the Qualcomm APQ8064 SOM device.
+
 config MACH_MPQ8064_CDP
 	depends on ARCH_APQ8064
 	bool "MPQ8064 CDP"
diff --git a/arch/arm/mach-msm/Makefile b/arch/arm/mach-msm/Makefile
index 7ad142b..5d5750a 100644
--- a/arch/arm/mach-msm/Makefile
+++ b/arch/arm/mach-msm/Makefile
@@ -287,6 +287,7 @@ obj-$(CONFIG_MACH_MSM8930_EVT) += board-8930-all.o board-8930-regulator-pm8038.o
 obj-$(CONFIG_PM8921_BMS) += bms-batterydata.o bms-batterydata-desay.o batterydata-lib.o
 obj-$(CONFIG_MACH_APQ8064_CDP) += board-8064-all.o board-8064-regulator.o
 obj-$(CONFIG_MACH_APQ8064_MTP) += board-8064-all.o board-8064-regulator.o
+obj-$(CONFIG_MACH_APQ8064_SOM) += board-8064-all.o board-8064-regulator.o
 obj-$(CONFIG_MACH_APQ8064_LIQUID) += board-8064-all.o board-8064-regulator.o
 obj-$(CONFIG_MACH_MPQ8064_HRD) += board-8064-all.o board-8064-regulator.o
 obj-$(CONFIG_MACH_MPQ8064_DTV) += board-8064-all.o board-8064-regulator.o
diff --git a/arch/arm/mach-msm/board-8064-gpiomux.c b/arch/arm/mach-msm/board-8064-gpiomux.c
index 41eee63..745d897 100644
--- a/arch/arm/mach-msm/board-8064-gpiomux.c
+++ b/arch/arm/mach-msm/board-8064-gpiomux.c
@@ -386,6 +386,13 @@ static struct gpiomux_setting ext_regulator_config = {
 	.dir = GPIOMUX_OUT_LOW,
 };
 
+/* SOM: Serial UART-2wire GSBI6 */
+static struct gpiomux_setting gsbi6_uart_config = {
+	.func = GPIOMUX_FUNC_2,
+	.drv = GPIOMUX_DRV_8MA,
+	.pull = GPIOMUX_PULL_NONE,
+};
+
 static struct gpiomux_setting gsbi7_func1_cfg = {
 	.func = GPIOMUX_FUNC_1,
 	.drv = GPIOMUX_DRV_8MA,
@@ -617,6 +624,22 @@ static struct msm_gpiomux_config apq8064_hdmi_configs[] __initdata = {
 	},
 };
 
+/* SOM: Serial UART-2wire GSBI6 */
+static struct msm_gpiomux_config apq8064_som_gsbi_configs[] __initdata = {
+	{
+		.gpio      = 14,		/* GSBI6 UART TX */
+		.settings = {
+			[GPIOMUX_SUSPENDED] = &gsbi6_uart_config,
+		},
+	},
+	{
+		.gpio      = 15,		/* GSBI6 UART RX */
+		.settings = {
+			[GPIOMUX_SUSPENDED] = &gsbi6_uart_config,
+		},
+	},
+};
+
 static struct msm_gpiomux_config apq8064_gsbi_configs[] __initdata = {
 	{
 		.gpio      = 8,			/* GSBI3 I2C QUP SDA */
@@ -644,6 +667,7 @@ static struct msm_gpiomux_config apq8064_gsbi_configs[] __initdata = {
 			[GPIOMUX_SUSPENDED] = &gsbi1_uart_config,
 		},
 	},
+
 #if defined(CONFIG_KS8851) || defined(CONFIG_KS8851_MODULE)
 	{
 		.gpio      = 51,		/* GSBI5 QUP SPI_DATA_MOSI */
@@ -1499,15 +1523,25 @@ void __init apq8064_init_gpiomux(void)
 				ARRAY_SIZE(apq8064_ethernet_configs));
 		#endif
 
+		/* SOM: Serial */
+		if(machine_is_apq8064_som()) {
+		msm_gpiomux_install(apq8064_som_gsbi_configs,
+				ARRAY_SIZE(apq8064_som_gsbi_configs));
+		}
+		else {
 		msm_gpiomux_install(apq8064_gsbi_configs,
 				ARRAY_SIZE(apq8064_gsbi_configs));
+		}
 	}
 
 	msm_gpiomux_install(apq8064_slimbus_config,
 			ARRAY_SIZE(apq8064_slimbus_config));
 
+	/* SOM: Disable Audio codec */
+	if (!machine_is_apq8064_som()) {
 	msm_gpiomux_install(apq8064_audio_codec_configs,
 			ARRAY_SIZE(apq8064_audio_codec_configs));
+	}
 
 	if (machine_is_mpq8064_cdp() || machine_is_mpq8064_hrd() ||
 		machine_is_mpq8064_dtv()) {
@@ -1524,8 +1558,11 @@ void __init apq8064_init_gpiomux(void)
 		msm_gpiomux_install(mpq8064_mi2s_configs,
 			ARRAY_SIZE(mpq8064_mi2s_configs));
 
-	msm_gpiomux_install(apq8064_ext_regulator_configs,
+	/* SOM: Doesnt have 3.3V boost */
+	if (!machine_is_apq8064_som()) {
+		msm_gpiomux_install(apq8064_ext_regulator_configs,
 			ARRAY_SIZE(apq8064_ext_regulator_configs));
+	}
 
 	if (machine_is_apq8064_mtp()) {
 		if (socinfo_get_platform_subtype() == PLATFORM_SUBTYPE_DSDA2) {
@@ -1589,8 +1626,12 @@ void __init apq8064_init_gpiomux(void)
 			     ARRAY_SIZE(apq8064_sdc4_configs));
 #endif
 
-	msm_gpiomux_install(apq8064_sdc3_configs,
+	/* SOM: Doesn't have SDC3 */
+	if (!machine_is_apq8064_som()) {
+		msm_gpiomux_install(apq8064_sdc3_configs,
 			ARRAY_SIZE(apq8064_sdc3_configs));
+	}
+
 	 if (machine_is_mpq8064_hrd() || machine_is_mpq8064_dtv())
 		msm_gpiomux_install(mpq8064_uartdm_configs,
 				ARRAY_SIZE(mpq8064_uartdm_configs));
diff --git a/arch/arm/mach-msm/board-8064.c b/arch/arm/mach-msm/board-8064.c
index 81aac6e..4a19631 100644
--- a/arch/arm/mach-msm/board-8064.c
+++ b/arch/arm/mach-msm/board-8064.c
@@ -2523,8 +2523,12 @@ static struct platform_device *common_devices[] __initdata = {
 };
 
 static struct platform_device *cdp_devices[] __initdata = {
+#ifdef CONFIG_MACH_APQ8064_SOM
+	&apq8064_device_uart_gsbi6,
+#else
 	&apq8064_device_uart_gsbi1,
 	&apq8064_device_uart_gsbi7,
+#endif
 	&msm_device_sps_apq8064,
 #ifdef CONFIG_MSM_ROTATOR
 	&msm_rotator_device,
@@ -3131,6 +3135,8 @@ static void __init register_i2c_devices(void)
 	int i;
 
 #ifdef CONFIG_MSM_CAMERA
+/* SOM: Disable camera for bringup */
+#ifndef CONFIG_MACH_APQ8064_SOM
 	struct i2c_registry apq8064_camera_i2c_devices = {
 		I2C_SURF | I2C_FFA | I2C_LIQUID | I2C_RUMI,
 		APQ_8064_GSBI4_QUP_I2C_BUS_ID,
@@ -3138,6 +3144,7 @@ static void __init register_i2c_devices(void)
 		apq8064_camera_board_info.num_i2c_board_info,
 	};
 #endif
+#endif
 	/* Build the matching 'supported_machs' bitmask */
 	if (machine_is_apq8064_cdp())
 		mach_mask = I2C_SURF;
@@ -3158,11 +3165,14 @@ static void __init register_i2c_devices(void)
 						apq8064_i2c_devices[i].len);
 	}
 #ifdef CONFIG_MSM_CAMERA
+	/* SOM: Disable camera temp */
+#ifndef CONFIG_MACH_APQ8064_SOM
 	if (apq8064_camera_i2c_devices.machs & mach_mask)
 		i2c_register_board_info(apq8064_camera_i2c_devices.bus,
 			apq8064_camera_i2c_devices.info,
 			apq8064_camera_i2c_devices.len);
 #endif
+#endif
 
 	for (i = 0; i < ARRAY_SIZE(mpq8064_i2c_devices); ++i) {
 		if (mpq8064_i2c_devices[i].machs & mach_mask)
@@ -3255,8 +3265,11 @@ static void __init apq8064_common_init(void)
 		pr_err("Failed to initialize XO votes\n");
 	msm_clock_init(&apq8064_clock_init_data);
 	apq8064_init_gpiomux();
-	apq8064_i2c_init();
-	register_i2c_devices();
+	/* SOM: Disable I2C devices */
+	if(!machine_is_apq8064_som()) { 
+		apq8064_i2c_init();
+		register_i2c_devices();
+	}
 
 	apq8064_device_qup_spi_gsbi5.dev.platform_data =
 						&apq8064_qup_spi_gsbi5_pdata;
@@ -3376,14 +3389,21 @@ static void __init apq8064_cdp_init(void)
 		ethernet_init();
 		msm_rotator_set_split_iommu_domain();
 		platform_add_devices(cdp_devices, ARRAY_SIZE(cdp_devices));
+		/* SOM: No SPI Devices */
+		if(!machine_is_apq8064_som())
 		spi_register_board_info(spi_board_info,
 						ARRAY_SIZE(spi_board_info));
 	}
 	apq8064_init_fb();
-	apq8064_init_gpu();
-	platform_add_devices(apq8064_footswitch, apq8064_num_footswitch);
+	/* SOM: temp disabled */
+	if(!machine_is_apq8064_som()) {
+		apq8064_init_gpu();
+		platform_add_devices(apq8064_footswitch, apq8064_num_footswitch);
+	}
 #ifdef CONFIG_MSM_CAMERA
-	apq8064_init_cam();
+	/* SOM: temp disabled */
+	if(!machine_is_apq8064_som()) 
+		apq8064_init_cam();
 #endif
 
 	if (machine_is_mpq8064_hrd() || machine_is_mpq8064_dtv()) {
@@ -3396,7 +3416,9 @@ static void __init apq8064_cdp_init(void)
 		platform_device_register(&mpq8064_device_uartdm_gsbi6);
 	}
 
-	if (machine_is_apq8064_cdp() || machine_is_apq8064_liquid())
+	/* SOM */
+	if (machine_is_apq8064_cdp() || machine_is_apq8064_liquid()
+		|| machine_is_apq8064_som())
 		platform_device_register(&cdp_kp_pdev);
 
 	if (machine_is_apq8064_mtp())
@@ -3444,6 +3466,18 @@ MACHINE_START(APQ8064_LIQUID, "QCT APQ8064 LIQUID")
 	.restart = msm_restart,
 MACHINE_END
 
+MACHINE_START(APQ8064_SOM, "QCT APQ8064 SOM")
+    .map_io = apq8064_map_io,
+    .reserve = apq8064_reserve,
+    .init_irq = apq8064_init_irq,
+    .handle_irq = gic_handle_irq,
+    .timer = &msm_timer,
+    .init_machine = apq8064_cdp_init,
+    .init_early = apq8064_allocate_memory_regions,
+    .init_very_early = apq8064_early_reserve,
+    .restart = msm_restart,
+MACHINE_END
+
 MACHINE_START(MPQ8064_CDP, "QCT MPQ8064 CDP")
 	.map_io = apq8064_map_io,
 	.reserve = apq8064_reserve,
diff --git a/arch/arm/mach-msm/clock-8960.c b/arch/arm/mach-msm/clock-8960.c
index e802bf2..31de28d 100755
--- a/arch/arm/mach-msm/clock-8960.c
+++ b/arch/arm/mach-msm/clock-8960.c
@@ -5311,7 +5311,11 @@ static struct clk_lookup msm_clocks_8064[] = {
 	CLK_LOOKUP("core_clk",		gsbi4_uart_clk.c, "msm_serial_hs.1"),
 #endif
 	CLK_LOOKUP("core_clk",		gsbi5_uart_clk.c,	""),
+#ifdef CONFIG_MACH_APQ8064_SOM
+	CLK_LOOKUP("core_clk",		gsbi6_uart_clk.c, "msm_serial_hsl.0"),
+#else
 	CLK_LOOKUP("core_clk",		gsbi6_uart_clk.c, "msm_serial_hs.0"),
+#endif
 #ifdef CONFIG_MACH_LGE
 	CLK_LOOKUP("core_clk",		gsbi7_uart_clk.c,	""),
 #else
@@ -5373,7 +5377,11 @@ static struct clk_lookup msm_clocks_8064[] = {
 	CLK_LOOKUP("iface_clk",		gsbi4_p_clk.c,	"msm_serial_hs.1"),
 	CLK_LOOKUP("iface_clk",		gsbi5_p_clk.c,		"spi_qsd.0"),
 	CLK_LOOKUP("iface_clk",		gsbi5_p_clk.c,		"qup_i2c.5"),
+#ifdef CONFIG_MACH_APQ8064_SOM
+	CLK_LOOKUP("iface_clk",		gsbi6_p_clk.c,	"msm_serial_hsl.0"),
+#else
 	CLK_LOOKUP("iface_clk",		gsbi6_p_clk.c,	"msm_serial_hs.0"),
+#endif
 #ifdef CONFIG_MACH_LGE
 	CLK_LOOKUP("iface_clk",		gsbi7_p_clk.c,		""),
 #else
diff --git a/arch/arm/mach-msm/devices-8064.c b/arch/arm/mach-msm/devices-8064.c
index 8f18c4a..358663e 100644
--- a/arch/arm/mach-msm/devices-8064.c
+++ b/arch/arm/mach-msm/devices-8064.c
@@ -532,6 +532,34 @@ struct platform_device mpq8064_device_uartdm_gsbi6 = {
 	},
 };
 
+/* SOM: UAR-2wire serial port on GSBI6 */
+static struct resource resources_uart_gsbi6[] = {
+	{
+		.start	= GSBI6_UARTDM_IRQ,
+		.end	= GSBI6_UARTDM_IRQ,
+		.flags	= IORESOURCE_IRQ,
+	},
+	{
+		.start	= MSM_UART6DM_PHYS,
+		.end	= MSM_UART6DM_PHYS + PAGE_SIZE - 1,
+		.name	= "uartdm_resource",
+		.flags	= IORESOURCE_MEM,
+	},
+	{
+		.start	= MSM_GSBI6_PHYS,
+		.end	= MSM_GSBI6_PHYS + PAGE_SIZE - 1,
+		.name	= "gsbi_resource",
+		.flags	= IORESOURCE_MEM,
+	},
+};
+
+struct platform_device apq8064_device_uart_gsbi6 = {
+	.name	= "msm_serial_hsl",
+	.id	= 0,
+	.num_resources	= ARRAY_SIZE(resources_uart_gsbi6),
+	.resource	= resources_uart_gsbi6,
+};
+
 static struct resource resources_uart_gsbi7[] = {
 	{
 		.start	= GSBI7_UARTDM_IRQ,
diff --git a/arch/arm/mach-msm/devices.h b/arch/arm/mach-msm/devices.h
index d10aa0a..960f1e5 100644
--- a/arch/arm/mach-msm/devices.h
+++ b/arch/arm/mach-msm/devices.h
@@ -88,6 +88,7 @@ extern struct platform_device apq8064_device_uart_gsbi1;
 extern struct platform_device apq8064_device_uart_gsbi3;
 extern struct platform_device apq8064_device_uart_gsbi4;
 extern struct platform_device apq8064_device_uartdm_gsbi4;
+extern struct platform_device apq8064_device_uart_gsbi6;
 extern struct platform_device apq8064_device_uart_gsbi7;
 extern struct platform_device apq8064_device_qup_i2c_gsbi1;
 extern struct platform_device apq8064_device_qup_i2c_gsbi3;
diff --git a/arch/arm/tools/mach-types b/arch/arm/tools/mach-types
index aa50e16..db681bc 100644
--- a/arch/arm/tools/mach-types
+++ b/arch/arm/tools/mach-types
@@ -1187,6 +1187,7 @@ msm7627a_evb		MACH_MSM7627A_EVB	MSM7627A_EVB		3934
 apq8064_cdp		MACH_APQ8064_CDP	APQ8064_CDP		3948
 apq8064_mtp		MACH_APQ8064_MTP	APQ8064_MTP		3949
 apq8064_liquid		MACH_APQ8064_LIQUID	APQ8064_LIQUID		3951
+apq8064_som		MACH_APQ8064_SOM	APQ8064_SOM		3953
 mpq8064_cdp		MACH_MPQ8064_CDP	MPQ8064_CDP		3993
 mpq8064_hrd		MACH_MPQ8064_HRD	MPQ8064_HRD		3994
 mpq8064_dtv		MACH_MPQ8064_DTV	MPQ8064_DTV		3995
diff --git a/drivers/media/video/msm/Makefile b/drivers/media/video/msm/Makefile
index 5921632..2ae33ca 100644
--- a/drivers/media/video/msm/Makefile
+++ b/drivers/media/video/msm/Makefile
@@ -15,7 +15,7 @@ ifeq ($(CONFIG_MSM_CAMERA_V4L2),y)
   obj-$(CONFIG_MSM_CAM_IRQ_ROUTER) += msm_camirq_router.o
   obj-$(CONFIG_MSM_CAMERA) += cci/ eeprom/ sensors/ actuators/ csi/
   obj-$(CONFIG_MSM_CPP) += cpp/
-  obj-$(CONFIG_MSM_CAMERA) += msm_gesture.o
+#  obj-$(CONFIG_MSM_CAMERA) += msm_gesture.o
 else
   obj-$(CONFIG_MSM_CAMERA) += msm_camera.o
 endif
@@ -56,3 +56,4 @@ obj-$(CONFIG_MT9D112) += mt9d112.o mt9d112_reg.o
 
 obj-$(CONFIG_MT9D113) += mt9d113.o mt9d113_reg.o
 obj-$(CONFIG_MSM_V4L2_VIDEO_OVERLAY_DEVICE) += msm_v4l2_video.o
+
-- 
1.8.2.1

