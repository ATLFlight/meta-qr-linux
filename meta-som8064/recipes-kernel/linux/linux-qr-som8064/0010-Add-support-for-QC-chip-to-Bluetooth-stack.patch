From 5c5a6653a9f0461ee13711c41fcc9f3295c071fb Mon Sep 17 00:00:00 2001
From: Gene Marsh <gmarsh@codeaurora.org>
Date: Tue, 20 May 2014 15:05:28 -0700
Subject: [PATCH] Add support for QC chip to Bluetooth stack.

---
 drivers/bluetooth/hci_smd.c  |   14 +-------------
 drivers/bluetooth/hci_uart.h |    1 +
 include/net/bluetooth/hci.h  |    1 +
 net/bluetooth/Makefile       |    4 ++--
 4 files changed, 5 insertions(+), 15 deletions(-)

diff --git a/drivers/bluetooth/hci_smd.c b/drivers/bluetooth/hci_smd.c
index 90e7263..aa5921e 100644
--- a/drivers/bluetooth/hci_smd.c
+++ b/drivers/bluetooth/hci_smd.c
@@ -148,12 +148,6 @@ static int hci_smd_close(struct hci_dev *hdev)
 }
 
 
-static void hci_smd_destruct(struct hci_dev *hdev)
-{
-	if (NULL != hdev->driver_data)
-		kfree(hdev->driver_data);
-}
-
 static void hci_smd_recv_data(void)
 {
 	int len = 0;
@@ -486,12 +480,9 @@ static int hci_smd_register_smd(struct hci_smd_data *hsmd)
 
 	hsmd->hdev = hdev;
 	hdev->bus = HCI_SMD;
-	hdev->driver_data = NULL;
 	hdev->open  = hci_smd_open;
 	hdev->close = hci_smd_close;
 	hdev->send  = hci_smd_send_frame;
-	hdev->destruct = hci_smd_destruct;
-	hdev->owner = THIS_MODULE;
 
 
 	tasklet_init(&hsmd->rx_task,
@@ -545,10 +536,7 @@ static void hci_smd_deregister_dev(struct hci_smd_data *hsmd)
 		BT_INFO("HCI device un-registration going on");
 
 		if (hsmd->hdev) {
-			if (hci_unregister_dev(hsmd->hdev) < 0)
-				BT_ERR("Can't unregister HCI device %s",
-					hsmd->hdev->name);
-
+			hci_unregister_dev(hsmd->hdev);
 			hci_free_dev(hsmd->hdev);
 			hsmd->hdev = NULL;
 		}
diff --git a/drivers/bluetooth/hci_uart.h b/drivers/bluetooth/hci_uart.h
index 6cf6ab22..70bef61 100644
--- a/drivers/bluetooth/hci_uart.h
+++ b/drivers/bluetooth/hci_uart.h
@@ -43,6 +43,7 @@
 #define HCI_UART_H4DS	3
 #define HCI_UART_LL	4
 #define HCI_UART_ATH3K	5
+#define HCI_UART_IBS	6
 
 #define HCI_UART_RAW_DEVICE	0
 #define HCI_UART_RESET_ON_INIT	1
diff --git a/include/net/bluetooth/hci.h b/include/net/bluetooth/hci.h
index 7840de2..30fcda7 100644
--- a/include/net/bluetooth/hci.h
+++ b/include/net/bluetooth/hci.h
@@ -51,6 +51,7 @@
 #define HCI_RS232	4
 #define HCI_PCI		5
 #define HCI_SDIO	6
+#define HCI_SMD         7
 
 /* HCI controller types */
 #define HCI_BREDR	0x00
diff --git a/net/bluetooth/Makefile b/net/bluetooth/Makefile
index 828be1d..a230b14 100644
--- a/net/bluetooth/Makefile
+++ b/net/bluetooth/Makefile
@@ -9,5 +9,5 @@ obj-$(CONFIG_BT_CMTP)	+= cmtp/
 obj-$(CONFIG_BT_HIDP)	+= hidp/
 
 bluetooth-y := af_bluetooth.o hci_core.o hci_conn.o hci_event.o mgmt.o \
-	hci_sock.o hci_sysfs.o l2cap_core.o l2cap_sock.o smp.o sco.o lib.o \
-	amp.o
+	hci_sock.o hci_sysfs.o l2cap_core.o l2cap_sock.o smp.o sco.o lib.o
+
-- 
1.7.9.5

