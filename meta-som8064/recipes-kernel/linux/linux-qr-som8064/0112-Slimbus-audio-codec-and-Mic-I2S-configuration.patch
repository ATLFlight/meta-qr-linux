From 07b84bda11d8aff675d03c6e95dce24f8b41524d Mon Sep 17 00:00:00 2001
From: Simon Teplitsky <simont@codeaurora.org>
Date: Thu, 3 Apr 2014 18:44:34 -0700
Subject: [PATCH] Slimbus audio codec and Mic I2S configuration

---
 arch/arm/mach-msm/board-8064-gpiomux.c | 43 ++++++++++++++++++++++++++++++++--
 arch/arm/mach-msm/board-8064.c         |  8 +++----
 sound/soc/msm/apq8064.c                | 31 ++++++++++++++++++++++++
 3 files changed, 76 insertions(+), 6 deletions(-)

diff --git a/arch/arm/mach-msm/board-8064-gpiomux.c b/arch/arm/mach-msm/board-8064-gpiomux.c
index 4375f43..9edb94a 100644
--- a/arch/arm/mach-msm/board-8064-gpiomux.c
+++ b/arch/arm/mach-msm/board-8064-gpiomux.c
@@ -372,11 +372,13 @@ static struct gpiomux_setting gpio_i2c_config_sus = {
 	.pull = GPIOMUX_PULL_KEEPER,
 };
 
+#ifndef CONFIG_MACH_APQ8064_SOM
 static struct gpiomux_setting mbhc_hs_detect = {
 	.func = GPIOMUX_FUNC_1,
 	.drv = GPIOMUX_DRV_2MA,
 	.pull = GPIOMUX_PULL_NONE,
 };
+#endif
 
 static struct gpiomux_setting cdc_mclk = {
 	.func = GPIOMUX_FUNC_1,
@@ -909,13 +911,48 @@ static struct msm_gpiomux_config mpq8064_spkr_i2s_config[] __initdata = {
 	},
 };
 
+static struct gpiomux_setting som_mic_i2s = {
+	.func = GPIOMUX_FUNC_1,
+	.drv = GPIOMUX_DRV_8MA,
+	.pull = GPIOMUX_PULL_KEEPER,
+};
+
+static struct msm_gpiomux_config apq8064_som_mic_i2s_config[] __initdata = {
+	{
+		.gpio   = 51,           /* mic i2s din */
+		.settings = {
+			[GPIOMUX_SUSPENDED] = &som_mic_i2s,
+		},
+	},
+	{
+		.gpio   = 52,           /* mic i2s sck */
+		.settings = {
+			[GPIOMUX_SUSPENDED] = &som_mic_i2s,
+		},
+	},
+	{
+		.gpio   = 53,           /* mic i2s ws */
+		.settings = {
+			[GPIOMUX_SUSPENDED] = &som_mic_i2s,
+		},
+	},
+	{
+		.gpio   = 54,           /* mic i2s mclk */
+		.settings = {
+			[GPIOMUX_SUSPENDED] = &som_mic_i2s,
+		},
+	},
+};
+
 static struct msm_gpiomux_config apq8064_audio_codec_configs[] __initdata = {
+#ifndef CONFIG_MACH_APQ8064_SOM
 	{
 		.gpio = 38,
 		.settings = {
 			[GPIOMUX_SUSPENDED] = &mbhc_hs_detect,
 		},
 	},
+#endif
 	{
 		.gpio = 39,
 		.settings = {
@@ -1652,10 +1689,12 @@ void __init apq8064_init_gpiomux(void)
 	msm_gpiomux_install(apq8064_slimbus_config,
 			ARRAY_SIZE(apq8064_slimbus_config));
 
-	/* SOM: Disable Audio codec */
-	if (!machine_is_apq8064_som()) {
 	msm_gpiomux_install(apq8064_audio_codec_configs,
 			ARRAY_SIZE(apq8064_audio_codec_configs));
+
+	if (machine_is_apq8064_som()) {
+		msm_gpiomux_install(apq8064_som_mic_i2s_config,
+			ARRAY_SIZE(apq8064_som_mic_i2s_config));
 	}
 
 	if (machine_is_mpq8064_cdp() || machine_is_mpq8064_hrd() ||
diff --git a/arch/arm/mach-msm/board-8064.c b/arch/arm/mach-msm/board-8064.c
index ba5bdb3..09bc2ed 100644
--- a/arch/arm/mach-msm/board-8064.c
+++ b/arch/arm/mach-msm/board-8064.c
@@ -3423,11 +3423,11 @@ static void __init apq8064_common_init(void)
 					&apq8064_uartdm_gsbi1_pdata;
 		platform_device_register(&apq8064_device_uartdm_gsbi1);
 		#endif
-	} else if (SOCINFO_VERSION_MINOR(platform_version) == 1) {
-		platform_device_register(&apq8064_slim_ctrl);
-		slim_register_board_info(apq8064_slim_devices,
-			ARRAY_SIZE(apq8064_slim_devices));
 	}
+	platform_device_register(&apq8064_slim_ctrl);
+	slim_register_board_info(apq8064_slim_devices,
+		ARRAY_SIZE(apq8064_slim_devices));
+
 	if (!PLATFORM_IS_MPQ8064()) {
 		apq8064_init_dsps();
 		platform_device_register(&msm_8960_riva);
diff --git a/sound/soc/msm/apq8064.c b/sound/soc/msm/apq8064.c
index 24453ec..b7e264b 100644
--- a/sound/soc/msm/apq8064.c
+++ b/sound/soc/msm/apq8064.c
@@ -507,6 +507,12 @@ static const struct snd_soc_dapm_widget apq8064_dapm_widgets[] = {
 	 */
 	SND_SOC_DAPM_MIC("Analog mic7", NULL),
 
+#ifdef CONFIG_MACH_APQ8064_SOM
+	SND_SOC_DAPM_MIC("Analog mic1", NULL),
+	SND_SOC_DAPM_MIC("Analog mic2", NULL),
+	SND_SOC_DAPM_MIC("Analog mic3", NULL),
+#endif
+
 	SND_SOC_DAPM_MIC("Headset Mic", NULL),
 	SND_SOC_DAPM_MIC("ANCRight Headset Mic", NULL),
 	SND_SOC_DAPM_MIC("ANCLeft Headset Mic", NULL),
@@ -532,6 +538,7 @@ static const struct snd_soc_dapm_route apq8064_common_audio_map[] = {
 
 	{"HEADPHONE", NULL, "LDO_H"},
 
+#ifndef CONFIG_MACH_APQ8064_SOM
 	/* Speaker path */
 #ifdef CONFIG_SND_SOC_TPA2028D
 	{"Ext Spk Top", NULL, "LINEOUT1"},
@@ -564,6 +571,21 @@ static const struct snd_soc_dapm_route apq8064_common_audio_map[] = {
 	{"AMIC4", NULL, "MIC BIAS1 Internal2"},
 	{"MIC BIAS1 Internal2", NULL, "ANCLeft Headset Mic"},
 #endif
+#endif /* CONFIG_MACH_APQ8064_SOM */
+};
+
+static const struct snd_soc_dapm_route apq8064_som_audio_map[] = {
+
+	/************   Analog MIC Paths  ************/
+	{"AMIC1", NULL, "MIC BIAS3 External"},
+	{"MIC BIAS3 External", NULL, "Analog mic1"},
+
+	{"AMIC2", NULL, "MIC BIAS2 External"},
+	{"MIC BIAS2 External", NULL, "Analog mic2"},
+
+	{"AMIC3", NULL, "MIC BIAS1 External"},
+	{"MIC BIAS1 External", NULL, "Analog mic3"},
+
 };
 
 static const struct snd_soc_dapm_route apq8064_mtp_audio_map[] = {
@@ -1262,6 +1284,9 @@ static int msm_audrx_init(struct snd_soc_pcm_runtime *rtd)
 	if (machine_is_apq8064_mtp() || machine_is_apq8064_mako()) {
 		snd_soc_dapm_add_routes(dapm, apq8064_mtp_audio_map,
 			ARRAY_SIZE(apq8064_mtp_audio_map));
+	} else if(machine_is_apq8064_som()) {
+		snd_soc_dapm_add_routes(dapm, apq8064_som_audio_map,
+			ARRAY_SIZE(apq8064_som_audio_map));
 	} else  {
 		snd_soc_dapm_add_routes(dapm, apq8064_liquid_cdp_audio_map,
 			ARRAY_SIZE(apq8064_liquid_cdp_audio_map));
@@ -1298,6 +1323,12 @@ static int msm_audrx_init(struct snd_soc_pcm_runtime *rtd)
 	codec_clk = clk_get(cpu_dai->dev, "osr_clk");
 
 #ifndef CONFIG_SWITCH_FSA8008
+
+	if(machine_is_apq8064_som()) {
+		pr_info("%s:APQ8064_SOM Not using MBHC mechanical switch\n", __func__);
+		apq8064_hs_detect_use_gpio = 0;
+	}
+
 	/* APQ8064 Rev 1.1 CDP and Liquid have mechanical switch */
 	revision = socinfo_get_version();
 	if (apq8064_hs_detect_use_gpio != -1) {
-- 
1.8.2.1

